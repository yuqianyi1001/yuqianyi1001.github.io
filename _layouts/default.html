<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <title>{% if page.title %}{{ page.title }} – {% endif %}{{ site.name }}</title>

    {% include meta.html %}

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2679768056572696"
            crossorigin="anonymous"></script>

    <link rel="icon" href="{{ '/images/yuqianyi-logo.png' | relative_url }}" type="image/png">
    <link rel="apple-touch-icon" href="{{ '/images/yuqianyi-logo.png' | relative_url }}">

    <link rel="stylesheet" type="text/css" href="{{ site.baseurl }}/style.css" />
    <link rel="alternate" type="application/rss+xml" title="{{ site.name }} - {{ site.description }}" href="{{ site.baseurl }}/feed.xml" />

    <style>
      .lang-toggle-button {
        font-size: smaller;
        padding: 4px 12px;
        border: 1px solid #b7a4ff;
        border-radius: 16px;
        background: #f5f0ff;
        color: #4f3cc9;
        cursor: pointer;
        transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
      }

      .lang-toggle-button[aria-pressed="true"] {
        background: #6a4bff;
        color: #fff;
        border-color: #6a4bff;
        box-shadow: 0 0 0 2px rgba(106, 75, 255, 0.2);
      }

      .lang-toggle-button:focus-visible {
        outline: 2px solid #6a4bff;
        outline-offset: 2px;
      }

      .wechat-link-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 18px;
        height: 18px;
        margin-left: 6px;
        border-radius: 4px;
        background: linear-gradient(135deg, #22ba19, #19a218);
        color: #fff;
        text-decoration: none;
        vertical-align: middle;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.12);
      }

      .wechat-link-icon:hover {
        background: linear-gradient(135deg, #1fa617, #158615);
      }

      .wechat-link-icon svg {
        width: 12px;
        height: 12px;
        fill: currentColor;
      }
    </style>

    <!-- Created with Jekyll Now - http://github.com/barryclark/jekyll-now -->
    <script src="https://cdn.jsdelivr.net/npm/opencc-js@1.0.5/dist/umd/full.min.js"></script>
  </head>

  <body>
    <div class="wrapper-masthead">
      <div class="container">
        <header class="masthead clearfix">
          <a href="{{ site.baseurl }}/" class="site-avatar"><img src="{{ site.avatar }}" /></a>

          <div class="site-info">
            <a href="{{ site.baseurl }}/" style="font-size: larger;">{{ site.name }}</a>
            <p class="site-description">学佛心得，涵盖南传上座部佛教，汉传佛教，藏传佛教，以及各宗派：<br>禅宗，净土，唯识，俱舍，天台，华严，律宗，密宗等；供初学们以启发，供老参们以参考</p>
          </div>

          <nav>
            <a href="{{ site.baseurl }}/">文章列表</a>
            <!-- <a href="{{ site.baseurl }}/buddha-names">佛名大全<span style="font-size: small;">(总23772)</span></a> -->
            <a href="{{ site.baseurl }}/100">百法大图</a>
            <a href="{{ site.baseurl }}/xianguan">现观大纲</a>
            <a href="{{ site.baseurl }}/about">我的闻思</a>
            <a href="{{ site.baseurl }}/ahan">阿含对比</a>
          </nav>
        </header>
        <div id="lang-toggle" style="margin: 8px 0 4px;">
          <button type="button" id="lang-toggle-button" class="lang-toggle-button" aria-pressed="false">切换繁体</button>
        </div>
      </div>
    </div>

    <div id="main" role="main" class="container">
      {{ content }}
    </div>

    <div class="wrapper-footer">
      <div class="container">
        <footer class="footer">
          {% include svg-icons.html %}
          <div class="footer-links">
            <a href="{{ '/privacy-policy/' | relative_url }}">隐私政策</a>
            <span class="footer-separator">·</span>
            <a href="{{ '/disclaimer/' | relative_url }}">免责声明</a>
          </div>
        </footer>
      </div>
    </div>

    {% include analytics.html %}

    <script>
      (function() {
        // Compat for legacy _zh-tw URLs: redirect to simplified path and keep TW mode
        (function handleLegacyZhTwUrl(){
          try {
            const m = window.location.pathname.match(/^(.*)_zh-tw\/?$/i);
            if (m) {
              localStorage.setItem('lang', 'zh-TW');
              const target = m[1] + '/';
              const dest = target + window.location.search + window.location.hash;
              window.location.replace(dest);
            }
          } catch (e) { /* ignore */ }
        })();
        const toggleButton = document.getElementById('lang-toggle-button');
        // init converters
        const toTW = (window.OpenCC && OpenCC.Converter) ? OpenCC.Converter({ from: 'cn', to: 'tw' }) : (s => s);
        const toCN = (window.OpenCC && OpenCC.Converter) ? OpenCC.Converter({ from: 'tw', to: 'cn' }) : (s => s);
        // expose for other pages (e.g., index filter)
        window.twConv = toTW;
        window.cnConv = toCN;

        function getLang() {
          return localStorage.getItem('lang') || 'zh-CN';
        }

        function setLang(lang) {
          const normalizedLang = (lang === 'zh-TW') ? 'zh-TW' : 'zh-CN';
          localStorage.setItem('lang', normalizedLang);
          document.body.setAttribute('data-lang', normalizedLang);
          if (document && document.documentElement) {
            document.documentElement.setAttribute('lang', normalizedLang);
          }
          if (toggleButton) {
            const isTraditional = (normalizedLang === 'zh-TW');
            toggleButton.setAttribute('aria-pressed', isTraditional ? 'true' : 'false');
            // keep text in Simplified; conversion runs after this call
            toggleButton.textContent = isTraditional ? '切换简体' : '切换繁体';
          }
          // apply conversion
          applyConversion(normalizedLang);
          // notify pages that language changed
          const evt = new CustomEvent('langchange', { detail: { lang: normalizedLang } });
          window.dispatchEvent(evt);
        }

        function applyConversion(lang) {
          const conv = (lang === 'zh-TW') ? toTW : toCN;
          // convert document title
          if (document && document.title) {
            document.title = conv(document.title);
          }
          // walk text nodes
          const skipTags = new Set(['SCRIPT','STYLE','CODE','PRE','TEXTAREA','NOSCRIPT']);
          const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT, {
            acceptNode(node) {
              if (!node || !node.nodeValue || !node.nodeValue.trim()) return NodeFilter.FILTER_REJECT;
              const p = node.parentNode;
              if (!p || skipTags.has(p.nodeName)) return NodeFilter.FILTER_REJECT;
              if (p.closest && p.closest('[data-no-translate]')) return NodeFilter.FILTER_REJECT;
              return NodeFilter.FILTER_ACCEPT;
            }
          });
          const nodes = [];
          while (walker.nextNode()) nodes.push(walker.currentNode);
          nodes.forEach(n => { n.nodeValue = conv(n.nodeValue); });
        }

        // init
        const initLang = getLang();
        setLang(initLang);

        if (toggleButton) {
          toggleButton.addEventListener('click', function() {
            const isPressed = toggleButton.getAttribute('aria-pressed') === 'true';
            const lang = isPressed ? 'zh-CN' : 'zh-TW';
            setLang(lang);
          });
        }
      })();
    </script>

    <script>
      (function() {
        // wechat_link -> site url mapping (generated at build time)
        var rawMap = {
{% assign wechat_posts = site.posts | where_exp: "p", "p.wechat_link" -%}
{% for post in wechat_posts %}
          {{ post.wechat_link | jsonify }}: { url: {{ post.url | absolute_url | jsonify }}, title: {{ post.title | jsonify }} }{% unless forloop.last %},{% endunless %}
{% endfor %}
        };

        function normalizeWeChat(url) {
          if (!url) return '';
          try {
            var u = new URL(url, window.location.href);
            // normalize protocol/host, drop trailing slash
            return (u.origin.toLowerCase() + u.pathname.replace(/\/$/, '') + (u.search || '')).replace(/\/$/, '');
          } catch (e) {
            return url.replace(/#.*$/, '').replace(/\/$/, '');
          }
        }

        var wechatMap = {};
        Object.keys(rawMap).forEach(function(key) {
          wechatMap[normalizeWeChat(key)] = rawMap[key];
        });

        function upgradeWeChatLinks() {
          var anchors = document.querySelectorAll('.entry a[href*="mp.weixin.qq.com"]');
          anchors.forEach(function(anchor) {
            if (anchor.dataset.wechatUpgraded === '1') return;
            var originalHref = anchor.getAttribute('href') || '';
            var normalizedHref = normalizeWeChat(originalHref);
            var mapped = wechatMap[normalizedHref];
            if (!mapped || !mapped.url) return;

            anchor.dataset.wechatUpgraded = '1';
            anchor.setAttribute('href', mapped.url);

            var iconLink = document.createElement('a');
            iconLink.className = 'wechat-link-icon';
            iconLink.href = originalHref;
            iconLink.target = '_blank';
            iconLink.rel = 'noopener noreferrer nofollow';
            iconLink.title = '微信原文';
            iconLink.setAttribute('aria-label', '微信原文');
            iconLink.innerHTML = '<svg viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path d="M9.5 4C6.46 4 4 6.24 4 9c0 1.48.73 2.8 1.9 3.75L5 15l2.2-1.1c.7.23 1.45.35 2.3.35 3.04 0 5.5-2.24 5.5-5S12.54 4 9.5 4zm5 3c-.55 0-1 .4-1 .9s.45.9 1 .9 1-.4 1-.9S15.05 7 14.5 7zm-5 0c-.55 0-1 .4-1 .9s.45.9 1 .9 1-.4 1-.9S10.05 7 9.5 7z"></path><path d="M14 9c3.04 0 5.5 2.24 5.5 5 0 1.48-.73 2.8-1.9 3.75L18 20l-2.2-1.1c-.7.23-1.45.35-2.3.35-2.18 0-4.09-.98-5.04-2.47.48.08.97.12 1.48.12 3.04 0 5.5-2.24 5.5-5 0-.68-.15-1.32-.44-1.9z"></path></svg>';

            anchor.insertAdjacentText('afterend', ' ');
            anchor.insertAdjacentElement('afterend', iconLink);
          });
        }

        document.addEventListener('DOMContentLoaded', upgradeWeChatLinks);
      })();
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <title>{% if page.title %}{{ page.title }} – {% endif %}{{ site.name }}</title>

    {% include meta.html %}

    <link rel="icon" href="{{ '/images/yuqianyi-logo.png' | relative_url }}" type="image/png">
    <link rel="apple-touch-icon" href="{{ '/images/yuqianyi-logo.png' | relative_url }}">

    <link rel="stylesheet" type="text/css" href="{{ site.baseurl }}/style.css" />
    <link rel="alternate" type="application/rss+xml" title="{{ site.name }} - {{ site.description }}" href="{{ site.baseurl }}/feed.xml" />

    <style>
      .lang-toggle-button {
        font-size: smaller;
        padding: 4px 12px;
        border: 1px solid #b7a4ff;
        border-radius: 16px;
        background: #f5f0ff;
        color: #4f3cc9;
        cursor: pointer;
        transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
      }

      .lang-toggle-button[aria-pressed="true"] {
        background: #6a4bff;
        color: #fff;
        border-color: #6a4bff;
        box-shadow: 0 0 0 2px rgba(106, 75, 255, 0.2);
      }

      .lang-toggle-button:focus-visible {
        outline: 2px solid #6a4bff;
        outline-offset: 2px;
      }
    </style>

    <!-- Created with Jekyll Now - http://github.com/barryclark/jekyll-now -->
    <script src="https://cdn.jsdelivr.net/npm/opencc-js@1.0.5/dist/umd/full.min.js"></script>
  </head>

  <body>
    <div class="wrapper-masthead">
      <div class="container">
        <header class="masthead clearfix">
          <a href="{{ site.baseurl }}/" class="site-avatar"><img src="{{ site.avatar }}" /></a>

          <div class="site-info">
            <a href="{{ site.baseurl }}/" style="font-size: larger;">{{ site.name }}</a>
            <p class="site-description">学佛心得，涵盖南传上座部佛教，汉传佛教，藏传佛教，以及各宗派：<br>禅宗，净土，唯识，俱舍，天台，华严，律宗，密宗等；供初学们以启发，供老参们以参考</p>
          </div>

          <nav>
            <a href="{{ site.baseurl }}/">文章列表</a>
            <!-- <a href="{{ site.baseurl }}/buddha-names">佛名大全<span style="font-size: small;">(总23772)</span></a> -->
            <a href="{{ site.baseurl }}/100">百法大图</a>
            <a href="{{ site.baseurl }}/xianguan">现观大纲</a>
            <a href="{{ site.baseurl }}/about">我的闻思</a>
            <a href="{{ site.baseurl }}/ahan">阿含对比</a>
          </nav>
        </header>
        <div id="lang-toggle" style="margin: 8px 0 4px;">
          <button type="button" id="lang-toggle-button" class="lang-toggle-button" aria-pressed="false">切换繁体</button>
        </div>
      </div>
    </div>

    <div id="main" role="main" class="container">
      {{ content }}
    </div>

    <div class="wrapper-footer">
      <div class="container">
        <footer class="footer">
          {% include svg-icons.html %}
          <div class="footer-links">
            <a href="{{ '/privacy-policy/' | relative_url }}">隐私政策</a>
            <span class="footer-separator">·</span>
            <a href="{{ '/disclaimer/' | relative_url }}">免责声明</a>
          </div>
        </footer>
      </div>
    </div>

    {% include analytics.html %}

    <script>
      (function() {
        // Compat for legacy _zh-tw URLs: redirect to simplified path and keep TW mode
        (function handleLegacyZhTwUrl(){
          try {
            const m = window.location.pathname.match(/^(.*)_zh-tw\/?$/i);
            if (m) {
              localStorage.setItem('lang', 'zh-TW');
              const target = m[1] + '/';
              const dest = target + window.location.search + window.location.hash;
              window.location.replace(dest);
            }
          } catch (e) { /* ignore */ }
        })();
        const toggleButton = document.getElementById('lang-toggle-button');
        // init converters
        const toTW = (window.OpenCC && OpenCC.Converter) ? OpenCC.Converter({ from: 'cn', to: 'tw' }) : (s => s);
        const toCN = (window.OpenCC && OpenCC.Converter) ? OpenCC.Converter({ from: 'tw', to: 'cn' }) : (s => s);
        // expose for other pages (e.g., index filter)
        window.twConv = toTW;
        window.cnConv = toCN;

        function getLang() {
          return localStorage.getItem('lang') || 'zh-CN';
        }

        function setLang(lang) {
          const normalizedLang = (lang === 'zh-TW') ? 'zh-TW' : 'zh-CN';
          localStorage.setItem('lang', normalizedLang);
          document.body.setAttribute('data-lang', normalizedLang);
          if (document && document.documentElement) {
            document.documentElement.setAttribute('lang', normalizedLang);
          }
          if (toggleButton) {
            const isTraditional = (normalizedLang === 'zh-TW');
            toggleButton.setAttribute('aria-pressed', isTraditional ? 'true' : 'false');
            // keep text in Simplified; conversion runs after this call
            toggleButton.textContent = isTraditional ? '切换简体' : '切换繁体';
          }
          // apply conversion
          applyConversion(normalizedLang);
          // notify pages that language changed
          const evt = new CustomEvent('langchange', { detail: { lang: normalizedLang } });
          window.dispatchEvent(evt);
        }

        function applyConversion(lang) {
          const conv = (lang === 'zh-TW') ? toTW : toCN;
          // convert document title
          if (document && document.title) {
            document.title = conv(document.title);
          }
          // walk text nodes
          const skipTags = new Set(['SCRIPT','STYLE','CODE','PRE','TEXTAREA','NOSCRIPT']);
          const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT, {
            acceptNode(node) {
              if (!node || !node.nodeValue || !node.nodeValue.trim()) return NodeFilter.FILTER_REJECT;
              const p = node.parentNode;
              if (!p || skipTags.has(p.nodeName)) return NodeFilter.FILTER_REJECT;
              if (p.closest && p.closest('[data-no-translate]')) return NodeFilter.FILTER_REJECT;
              return NodeFilter.FILTER_ACCEPT;
            }
          });
          const nodes = [];
          while (walker.nextNode()) nodes.push(walker.currentNode);
          nodes.forEach(n => { n.nodeValue = conv(n.nodeValue); });
        }

        // init
        const initLang = getLang();
        setLang(initLang);

        if (toggleButton) {
          toggleButton.addEventListener('click', function() {
            const isPressed = toggleButton.getAttribute('aria-pressed') === 'true';
            const lang = isPressed ? 'zh-CN' : 'zh-TW';
            setLang(lang);
          });
        }
      })();
    </script>
  </body>
</html>

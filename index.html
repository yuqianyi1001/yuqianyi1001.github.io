---
layout: default
---

<div class="tag-filter-section">
  <style>
    .tag-filter-section {
      margin-bottom: 12px;
    }

    .tag-filter-heading {
      font-size: small;
      font-weight: bold;
      color: #444;
      margin: 0 0 4px 0;
    }

    #d_tags_cn {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 8px;
    }

    #d_tags_cn .tag-toggle {
      font-size: smaller;
      padding: 4px 10px;
      border: 1px solid #a4c8ff;
      border-radius: 16px;
      background: #f3f7ff;
      color: #1d4ed8;
      cursor: pointer;
      transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
    }

    #d_tags_cn .tag-toggle[aria-pressed="true"] {
      background: #2b90d9;
      color: #fff;
      border-color: #2b90d9;
      box-shadow: 0 0 0 2px rgba(43, 144, 217, 0.2);
    }

    #d_tags_cn .tag-toggle:focus-visible {
      outline: 2px solid #2b90d9;
      outline-offset: 2px;
    }

    #post-monthly-summary .month-toggle {
      font-size: smaller;
      padding: 4px 10px;
      border: 1px solid #f4b48c;
      border-radius: 16px;
      background: #fff6ed;
      color: #b45309;
      cursor: pointer;
      transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
    }

    #post-monthly-summary .month-toggle[aria-pressed="true"] {
      background: #e67e22;
      color: #fff;
      border-color: #e67e22;
      box-shadow: 0 0 0 2px rgba(230, 126, 34, 0.2);
    }

    #post-monthly-summary .month-toggle:focus-visible {
      outline: 2px solid #e67e22;
      outline-offset: 2px;
    }
  </style>
  <div class="tag-filter-heading">标签</div>
  <div id="d_tags_cn">
    {% assign all_tags = "" | split: "|" %}
    
    {%- for post in site.posts -%}
      {%- if post.url contains "zh-tw" -%}
        <!-- do nothing -->
      {%- else -%}

        {%- assign all_tags = all_tags | concat: post.tags -%}
      {%- endif -%}
    {%- endfor -%}
    
    {%- assign unique_tags = all_tags | uniq | sort -%}
      
      {%- for tag in unique_tags -%}
        {%- assign tag_count = 0 -%}
        {%- for tagged_post in site.posts -%}
          {%- unless tagged_post.url contains "zh-tw" -%}
            {%- if tagged_post.tags and tagged_post.tags contains tag -%}
              {%- assign tag_count = tag_count | plus: 1 -%}
            {%- endif -%}
          {%- endunless -%}
        {%- endfor -%}
        <button type="button" class="tag-toggle" data-tag="{{ tag }}" data-count="{{ tag_count }}" aria-pressed="false">{{ tag }} ({{ tag_count }})</button>
      {%- endfor -%}
  </div>
</div>

<div id="post-monthly-summary" style="margin-top: 10px;">
  <style>
    #post-monthly-summary .year-groups-extra { display: none; margin-top: 6px; }
    #post-monthly-summary.expanded .year-groups-extra { display: block; }
  </style>
  {%- assign posts_by_year = site.posts | group_by_exp: "post", "post.date | date: '%Y'" -%}
  {%- assign posts_by_year = posts_by_year | sort: 'name' | reverse -%}
  {%- assign first_year_done = 'false' -%}
  {%- assign first_year_markup = '' -%}
  {%- assign other_years_markup = '' -%}
  {%- assign has_extra_years = 'false' -%}
  {%- for year_group in posts_by_year -%}
    {%- assign posts_by_month = year_group.items | group_by_exp: "post", "post.date | date: '%m'" -%}
    {%- assign posts_by_month = posts_by_month | sort: 'name' | reverse -%}
    {%- assign month_markup = '' -%}
    {%- assign year_total = 0 -%}
    {%- for month_group in posts_by_month -%}
      {%- assign cn_count = 0 -%}
      {%- for post in month_group.items -%}
        {%- unless post.url contains 'zh-tw' -%}
          {%- assign cn_count = cn_count | plus: 1 -%}
        {%- endunless -%}
      {%- endfor -%}
      {%- if cn_count > 0 -%}
        {%- assign year_total = year_total | plus: cn_count -%}
        {%- capture month_markup -%}
          {{ month_markup }}<button type="button" class="month-toggle" data-year="{{ year_group.name }}" data-month="{{ month_group.name }}" data-count="{{ cn_count }}" aria-pressed="false">{{ month_group.name | plus: 0 }}月 ({{ cn_count }})</button>
        {%- endcapture -%}
      {%- endif -%}
    {%- endfor -%}
    {%- if year_total > 0 -%}
      {%- capture year_markup -%}
        <div class="year-group" data-year="{{ year_group.name }}" style="font-size: smaller; margin-top: 6px;">
          <span style="font-weight: bold;">{{ year_group.name }}年</span>
          <div class="month-summary" style="margin: 4px 0 0 1em; display: flex; flex-wrap: wrap; gap: 6px;">
            {{ month_markup | strip }}
          </div>
        </div>
      {%- endcapture -%}
      {%- if first_year_done == 'false' -%}
        {%- assign first_year_markup = year_markup -%}
        {%- assign first_year_done = 'true' -%}
      {%- else -%}
        {%- capture other_years_markup -%}{{ other_years_markup }}{{ year_markup }}{%- endcapture -%}
        {%- assign has_extra_years = 'true' -%}
      {%- endif -%}
    {%- endif -%}
  {%- endfor -%}
  {{ first_year_markup | strip }}
  {%- if has_extra_years == 'true' -%}
    <div id="post-monthly-summary-extra" class="year-groups-extra">
      {{ other_years_markup | strip }}
    </div>
    <a href="#" id="toggle-year-summary" style="display: inline-block; margin-top: 6px; font-size: x-small; color: #2b90d9; text-decoration: underline; cursor: pointer;" aria-expanded="false">更多</a>
  {%- endif -%}
</div>

<div class="row">
  
{% assign zh_tw_count = site.posts | where_exp: "post", "post.url contains 'zh-tw'" | size %}
{% assign total_posts = site.posts.size | minus: zh_tw_count %}

<h2 style="font-size: large;">文章列表 (共{{ total_posts }}篇，最新的文章在最上面)</h2>

<div class="posts posts-zh-cn" style="display:block;">
  <ol>
    {%- for post in site.posts -%}
      {%- unless post.url contains "zh-tw" -%}
      <li class="post" data-year="{{ post.date | date: '%Y' }}" data-month="{{ post.date | date: '%m' }}">
        
            <a href="{{ site.baseurl }}{{ post.url }}" class="read-more" id="post_title">{{ post.title }}</a>
            {%- assign wechat_link = post.wechat_link | default: '' | strip -%}
            {%- if wechat_link != '' -%}
            <a href="{{ wechat_link }}" target="_blank" id="wechat_link"><img src="/wechat.ico" width="16px" /></a>
            {%- endif -%}
            <img src="/copy.png" width="16px" id="copy-button" />
            <br>
            
            <span style="font-size:medium;" id="post-desc">{{ post.description }}</span>
            {%- for tag in post.tags -%}
              <code style="font-size: smaller;">{{ tag }}</code>
            {%- endfor -%}
            <time class="post-date" datetime="{{ post.date | date_to_xmlschema }}" style="font-size: smaller; color: #666;"> {{ post.date | date: "%Y-%m-%d" }}</time>
      </li>
      {%- endunless -%}
    {%- endfor -%}
  </ol>
</div>

</div>


  <script>
    function getLang() {
      return localStorage.getItem('lang') || 'zh-CN';
    }

    // language view controlled globally via conversion; no per-section toggling needed

    // respond to global toggle updates
    window.addEventListener('langchange', function(e) {
      const lang = (e && e.detail && e.detail.lang) ? e.detail.lang : getLang();
      if (typeof window.updatePostsVisibility === 'function') {
        window.updatePostsVisibility();
      }
    });

    // Copy button for visible posts
    const copyButtons = document.querySelectorAll('.posts img#copy-button');
    copyButtons.forEach((button) => {
      button.addEventListener('click', function() {
        const listItem = button.closest('li.post');
        if (!listItem) {
          return;
        }
        const titleEl = listItem.querySelector('#post_title');
        const postTitle = titleEl ? titleEl.innerText : '';
        const wechatLink = listItem.querySelector('#wechat_link');
        const postHref = wechatLink ? wechatLink.getAttribute('href') : '';
        const descEl = listItem.querySelector('#post-desc');
        const postDesc = descEl ? descEl.innerText : '';

        const tempTextarea = document.createElement('textarea');
        tempTextarea.value = `【原创】${postTitle}\n${postHref}\n ${postDesc}`;
        document.body.appendChild(tempTextarea);
        tempTextarea.select();
        document.execCommand('copy');
        document.body.removeChild(tempTextarea);
        button.src = '/success.png';
        setTimeout(function() { button.src = '/copy.png'; }, 1000);
      });
    });

    // Tags: sort and filter per language
    document.addEventListener('DOMContentLoaded', function() {
      const TAG_CONTAINER_ID = 'd_tags_cn';
      const TAG_SELECTOR = `#${TAG_CONTAINER_ID} .tag-toggle`;
      const MONTH_SELECTOR = '#post-monthly-summary .month-toggle';

      function sortTagContainer(containerId) {
        const container = document.getElementById(containerId);
        if (!container) return;
        const items = Array.from(container.querySelectorAll('.tag-toggle')).map(button => {
          const count = parseInt(button.dataset.count, 10) || 0;
          const tag = button.dataset.tag || '';
          return { button, count, tag };
        });
        items.sort((a, b) => {
          if (b.count !== a.count) {
            return b.count - a.count;
          }
          return a.tag.localeCompare(b.tag);
        });
        items.forEach(({ button }) => {
          container.appendChild(button);
        });
      }

      sortTagContainer(TAG_CONTAINER_ID);

      window.updatePostsVisibility = function updatePostsVisibility() {
        const lang = getLang();
        const activeTags = Array.from(document.querySelectorAll(TAG_SELECTOR))
          .filter(btn => btn.getAttribute('aria-pressed') === 'true')
          .map(btn => btn.dataset.tag);
        const activeMonths = Array.from(document.querySelectorAll(MONTH_SELECTOR))
          .filter(btn => btn.getAttribute('aria-pressed') === 'true')
          .map(btn => ({ year: btn.dataset.year, month: btn.dataset.month }));
        const scope = document.querySelector('.posts-zh-cn');
        const posts = scope ? scope.querySelectorAll('.post') : [];

        posts.forEach(post => {
          const postTagTexts = Array.from(post.querySelectorAll('code')).map(code => code.textContent.trim());
          const postTagTextsCN = (lang === 'zh-TW' && window.cnConv)
            ? postTagTexts.map(t => window.cnConv(t))
            : postTagTexts;
          const matchesTags = activeTags.length === 0 || activeTags.some(tag => postTagTextsCN.includes(tag));
          const postYear = post.dataset.year;
          const postMonth = post.dataset.month;
          const matchesMonths = activeMonths.length === 0 || activeMonths.some(({ year, month }) => (postYear === year && postMonth === month));
          post.classList.toggle('hidden', !(matchesTags && matchesMonths));
        });
      };

      // attach listeners
      document.querySelectorAll(TAG_SELECTOR).forEach(button => {
        button.addEventListener('click', () => {
          const currentState = button.getAttribute('aria-pressed') === 'true';
          button.setAttribute('aria-pressed', currentState ? 'false' : 'true');
          window.updatePostsVisibility();
        });
      });

      document.querySelectorAll(MONTH_SELECTOR).forEach(button => {
        button.addEventListener('click', () => {
          const currentState = button.getAttribute('aria-pressed') === 'true';
          button.setAttribute('aria-pressed', currentState ? 'false' : 'true');
          window.updatePostsVisibility();
        });
      });

      window.updatePostsVisibility();

      const moreButton = document.getElementById('toggle-year-summary');
      if (moreButton) {
        const summary = document.getElementById('post-monthly-summary');
        const extraContainer = summary ? summary.querySelector('.year-groups-extra') : null;
        let expanded = false;

        moreButton.addEventListener('click', (event) => {
          event.preventDefault();
          expanded = !expanded;
          if (summary && extraContainer) {
            summary.classList.toggle('expanded', expanded);
          }
          moreButton.textContent = expanded ? '收起' : '更多';
          moreButton.setAttribute('aria-expanded', expanded ? 'true' : 'false');
        });
      }
    });
  </script>

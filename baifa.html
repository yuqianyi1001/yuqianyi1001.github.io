---
layout: individual
title: 百法交互表
---

<style>
  .baifa-wrap {
    margin: 24px auto;
    max-width: 1400px;
    padding: 0 12px;
  }

  .baifa-table {
    margin-top: 50px;
    border-collapse: collapse;
    table-layout: fixed;
    width: 100%;
  }

  .baifa-table td {
    border: 1px solid #333;
    padding: 8px;
    vertical-align: middle;
  }

  .title-cell {
    background: #d9d9d9;
    font-size: 24px;
    font-weight: 700;
    letter-spacing: 4px;
    text-align: center;
  }

  .category {
    font-size: 20px;
    font-weight: 700;
    text-align: left;
  }

  .vertical-fallback {
    display: inline-block;
    line-height: 1.2;
    text-align: center;
    white-space: normal;
  }

  .category.heart {
    background: #dfead4;
  }

  .category.heart-assoc {
    background: #f2b5b8;
  }

  .category.color {
    background: #b8c0f2;
  }

  .category.nonconcurrent {
    background: #f2c5f5;
  }

  .category.unconditioned {
    background: #f6f06b;
  }

  .subcategory {
    background: #e7b188;
    font-size: 18px;
    font-weight: 700;
    text-align: left;
  }

  .subcategory2 {
    background: #e7b188;
    font-size: 15px;
    font-weight: 700;
    text-align: left;
  }

  .category[data-category],
  .subcategory[data-category],
  .subcategory2[data-category] {
    cursor: pointer;
  }

  .items-cell {
    background: #e6eef8;
  }

  .items-cell.alt {
    background: #f7f1d3;
  }

  .items {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  .item-btn {
    background: #8b4a1e;
    border: 1px solid #6b3310;
    border-radius: 4px;
    color: #fff;
    cursor: pointer;
    font-size: 14px;
    padding: 4px 8px;
    white-space: nowrap;
  }

  .items-heart .item-btn {
    background: #e6f2d8;
    border-color: #b7cf94;
    color: #2f3a20;
  }

  .items-neutral .item-btn {
    background: #d8ddd6;
    border-color: #b5beb2;
    color: #2c332c;
  }

  .items-wholesome .item-btn {
    background: #d1f6c8;
    border-color: #86c974;
    color: #1e451c;
  }

  .items-affliction-root .item-btn {
    background: #3f0d0d;
    border-color: #2b0707;
    color: #f7eaea;
  }

  .items-affliction-small .item-btn {
    background: #4f1717;
    border-color: #3a1010;
    color: #f7ecec;
  }

  .items-affliction-medium .item-btn {
    background: #5f2424;
    border-color: #461a1a;
    color: #f7eded;
  }

  .items-affliction-large .item-btn {
    background: #6f3131;
    border-color: #532424;
    color: #f7eeee;
  }

  .items-affliction-indeterminate .item-btn {
    background: #7f3e3e;
    border-color: #5f2c2c;
    color: #f8efef;
  }

  .items-color .item-btn {
    background: #d9defa;
    border-color: #9ea9e2;
    color: #273055;
  }

  .items-nonconcurrent .item-btn {
    background: #f7d7f9;
    border-color: #d5a6d9;
    color: #5a2a5f;
  }

  .items-unconditioned .item-btn {
    background: #fff4a8;
    border-color: #d9cb5a;
    color: #4a3d00;
  }

  .item-btn.is-highlighted {
    background: #d93025;
    border-color: #b3261e;
    box-shadow: 0 0 0 2px rgba(217, 48, 37, 0.55), 0 4px 10px rgba(0, 0, 0, 0.25);
    color: #fff;
  }

  .item-btn.is-highlighted-buddha {
    background: #64d466;
    border-color: #2f9b3b;
    box-shadow: 0 0 0 2px rgba(47, 155, 59, 0.55), 0 4px 10px rgba(0, 0, 0, 0.25);
    color: #0d2b15;
  }

  .baifa-tools-grid {
    display: grid;
    gap: 16px;
    margin: 18px 0 0;
  }

  .baifa-tools {
    background: #f2ede3;
    border: 1px solid #c8bb9c;
    border-radius: 8px;
    margin: 0;
    padding: 12px 14px;
  }

  .baifa-tools-title {
    font-size: 16px;
    font-weight: 700;
    margin: 0 0 2px;
  }

  .baifa-tools-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 6px 8px;
  }

  .baifa-tools-note {
    color: #5a4a2f;
    font-size: 12px;
  }

  .baifa-tools-note.inline {
    margin-left: 8px;
  }

  .baifa-tools-btn {
    background: #6a4b2a;
    border: 1px solid #4f371f;
    border-radius: 6px;
    color: #fff;
    cursor: pointer;
    font-size: 14px;
    padding: 6px 12px;
  }

  .baifa-tools-btn[aria-pressed="true"] {
    background: #3f2a12;
    border-color: #2d1d0c;
  }

  @media (min-width: 1160px) {
    .baifa-tools-grid {
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }

    .baifa-tools.is-full-row {
      grid-column: 1 / -1;
    }
  }

  @media (min-width: 860px) {
    .baifa-tools {
      align-items: center;
      column-gap: 5px;
      display: grid;
      grid-template-columns: minmax(40px, 80px) 1fr;
      row-gap: 6px;
    }

    .baifa-tools-title {
      margin: 0;
    }

    .baifa-tools-actions {
      justify-content: flex-start;
    }

    .baifa-tools-note {
      grid-column: 2 / -1;
    }

    .baifa-tools-note.inline {
      margin-left: 0;
    }
  }

  .baifa-modal {
    background: transparent;
    display: none;
    inset: 0;
    pointer-events: none;
    position: fixed;
    z-index: 1000;
  }

  .baifa-modal.active {
    display: block;
  }

  .baifa-modal-content {
    background: #d2d1d1;
    border: 2px solid #a5a4a4;
    border-radius: 8px;
    box-shadow: 0 12px 30px rgba(0, 0, 0, 0.25);
    font-weight: 400;
    max-height: 80vh;
    max-width: 720px;
    overflow: auto;
    padding: 8px 18px 20px;
    position: absolute;
    pointer-events: auto;
    opacity: 0;
    transition: opacity 290ms ease;
    /* width: min(720px, 92vw); */
  }

  .baifa-modal.is-open .baifa-modal-content {
    opacity: 1;
  }

  .baifa-modal.is-closing .baifa-modal-content {
    opacity: 0;
  }

  .baifa-modal-title {
    cursor: move;
    padding: 5px;
    background: #949393;
    border-radius: 4px;
    user-select: none;
    font-size: 18px;
    font-weight: 700;
    margin: 0 64px 10px 0;
  }

  .baifa-modal-desc {
    font-size: 15px;
    line-height: 1.1;
    margin: 0;
    white-space: normal;
  }

  .baifa-modal-close,
  .baifa-modal-copy {
    align-items: center;
    background: transparent;
    border: none;
    border-radius: 6px;
    color: #4f371f;
    cursor: pointer;
    display: inline-flex;
    height: 24px;
    justify-content: center;
    padding: 0;
    position: absolute;
    top: 6px;
    width: 24px;
  }

  .baifa-modal-copy {
    right: 36px;
  }

  .baifa-modal-close {
    right: 8px;
  }

  .baifa-modal-close:hover,
  .baifa-modal-copy:hover {
    background: #b8b7b7;
  }

  .baifa-modal-close:focus-visible,
  .baifa-modal-copy:focus-visible {
    outline: 2px solid #4f371f;
    outline-offset: 2px;
  }

  .baifa-modal-copy.is-copied {
    color: #2f5d3a;
  }

  .baifa-modal-copy.is-failed {
    color: #7a2b2b;
  }

  .baifa-modal-icon {
    fill: none;
    height: 16px;
    stroke: currentColor;
    stroke-linecap: round;
    stroke-linejoin: round;
    stroke-width: 2;
    width: 16px;
  }

  @media (prefers-reduced-motion: reduce) {
    .baifa-modal-content {
      transition: none;
    }
  }

  .baifa-section-title {
    display: block;
    font-size: 16px;
    font-weight: 600;
    margin: 12px 0 4px;
  }

  .baifa-section-title:first-child {
    margin-top: 0;
  }

  .baifa-section-body {
    display: block;
    font-weight: 400;
    margin: 0 0 8px;
  }

  .baifa-section-body code {
    background: #fbfaf8;
    border: 1px solid #fae7bb;
    border-radius: 3px;
    font-family: "SFMono-Regular", Menlo, monospace;
    font-size: 0.95em;
    padding: 0 4px;
  }

  .baifa-section-body p {
    margin: 0 0 8px;
  }

  .baifa-section-body ul,
  .baifa-section-body ol {
    margin: 6px 0 8px 20px;
    padding: 0;
  }

  .baifa-section-body li {
    margin: 2px 0;
  }

  .baifa-source-filters {
    background: #f2ede3;
    border: 1px solid #c8bb9c;
    border-radius: 8px;
    margin: 18px 0 0;
    padding: 10px 12px;
  }

  .baifa-source-filters-title {
    align-items: center;
    display: flex;
    flex-wrap: wrap;
    font-size: 14px;
    font-weight: 700;
    gap: 8px 12px;
    justify-content: space-between;
    margin: 0 0 6px;
  }

  .baifa-source-filters-actions {
    display: inline-flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  .baifa-source-action {
    background: #fff4d6;
    border: 1px solid #b79a65;
    border-radius: 999px;
    color: #4f371f;
    cursor: pointer;
    font-size: 12px;
    padding: 2px 10px;
  }

  .baifa-source-action:hover {
    background: #f8e6bb;
  }

  .baifa-source-action:focus-visible {
    outline: 2px solid #4f371f;
    outline-offset: 2px;
  }

  .baifa-source-filters-options {
    display: flex;
    flex-wrap: wrap;
    gap: 6px 12px;
  }

  .baifa-filter-option {
    align-items: center;
    display: inline-flex;
    font-size: 13px;
    gap: 4px;
    line-height: 1.2;
  }

  .baifa-filter-option.is-disabled {
    color: #8a8a8a;
  }

  .baifa-filter-option.is-disabled input {
    cursor: not-allowed;
  }

  .baifa-filter-option input {
    accent-color: #6a4b2a;
  }

  .baifa-source-filters-hint {
    color: #6d6d6d;
    font-size: 13px;
  }
</style>

<div class="baifa-wrap">
  <table class="baifa-table">
    <colgroup>
      <col style="width: 60px;">
      <col style="width: 50px;">
      <col style="width: 50px;">
      <col style="width: 110px;">
      <col>
    </colgroup>
    <tbody>
      <tr>
        <td class="title-cell" rowspan="12"><span class="vertical-fallback">大<br>乘<br>百<br>法<br>明<br>门<br>论<br>世<br>亲<br>菩<br>萨<br>著</span></td>
        <td class="category heart" colspan="3" data-category="心法">心法(8)</td>
        <td class="items-cell alt">
          <div class="items items-heart">
            <button type="button" class="item-btn">1.眼识</button>
            <button type="button" class="item-btn">2.耳识</button>
            <button type="button" class="item-btn">3.鼻识</button>
            <button type="button" class="item-btn">4.舌识</button>
            <button type="button" class="item-btn">5.身识</button>
            <button type="button" class="item-btn">6.意识</button>
            <button type="button" class="item-btn">7.末那识</button>
            <button type="button" class="item-btn">8.阿赖耶识</button>
          </div>
        </td>
      </tr>
      <tr>
        <td class="category heart-assoc" rowspan="8" data-category="心所有法"><span class="vertical-fallback">心<br>所<br>有<br>法<br>(51)</span></td>
        <td class="subcategory" colspan="2" data-category="遍行">遍行(5)</td>
        <td class="items-cell">
          <div class="items items-neutral">
            <button type="button" class="item-btn">9.作意</button>
            <button type="button" class="item-btn">10.触</button>
            <button type="button" class="item-btn">11.受</button>
            <button type="button" class="item-btn">12.想</button>
            <button type="button" class="item-btn">13.思</button>
          </div>
        </td>
      </tr>
      <tr>
        <td class="subcategory" colspan="2" data-category="别境">别境(5)</td>
        <td class="items-cell alt">
          <div class="items items-neutral">
            <button type="button" class="item-btn">14.欲</button>
            <button type="button" class="item-btn">15.胜解</button>
            <button type="button" class="item-btn">16.念</button>
            <button type="button" class="item-btn">17.定</button>
            <button type="button" class="item-btn">18.慧</button>
          </div>
        </td>
      </tr>
      <tr>
        <td class="subcategory" colspan="2" data-category="善法">善法(11)</td>
        <td class="items-cell">
          <div class="items items-wholesome">
            <button type="button" class="item-btn">19.信</button>
            <button type="button" class="item-btn">20.精进</button>
            <button type="button" class="item-btn">21.惭</button>
            <button type="button" class="item-btn">22.愧</button>
            <button type="button" class="item-btn">23.无贪</button>
            <button type="button" class="item-btn">24.无嗔</button>
            <button type="button" class="item-btn">25.无痴</button>
            <button type="button" class="item-btn">26.轻安</button>
            <button type="button" class="item-btn">27.不放逸</button>
            <button type="button" class="item-btn">28.行舍</button>
            <button type="button" class="item-btn">29.不害</button>
          </div>
        </td>
      </tr>
      <tr>
        <td class="subcategory" colspan="2" data-category="根本烦恼">根本烦恼(6)</td>
        <td class="items-cell alt">
          <div class="items items-affliction-root">
            <button type="button" class="item-btn">30.贪</button>
            <button type="button" class="item-btn">31.嗔</button>
            <button type="button" class="item-btn">32.痴</button>
            <button type="button" class="item-btn">33.慢</button>
            <button type="button" class="item-btn">34.疑</button>
            <button type="button" class="item-btn">35.不正见</button>
          </div>
        </td>
      </tr>
      <tr>
        <td class="subcategory" rowspan="3" data-category="随烦恼"><span class="vertical-fallback">随<br>烦<br>恼<br>(20)</span></td>
        <td class="subcategory2" data-category="小随烦恼">小随烦恼(10)</td>
        <td class="items-cell">
          <div class="items items-affliction-small">
            <button type="button" class="item-btn">36.忿</button>
            <button type="button" class="item-btn">37.恨</button>
            <button type="button" class="item-btn">38.覆</button>
            <button type="button" class="item-btn">39.恼</button>
            <button type="button" class="item-btn">40.诳</button>
            <button type="button" class="item-btn">41.谄</button>
            <button type="button" class="item-btn">42.憍</button>
            <button type="button" class="item-btn">43.害</button>
            <button type="button" class="item-btn">44.嫉</button>
            <button type="button" class="item-btn">45.悭</button>
          </div>
        </td>
      </tr>
      <tr>
        <td class="subcategory2" data-category="中随烦恼">中随烦恼(2)</td>
        <td class="items-cell alt">
          <div class="items items-affliction-medium">
            <button type="button" class="item-btn">46.无惭</button>
            <button type="button" class="item-btn">47.无愧</button>
          </div>
        </td>
      </tr>
      <tr>
        <td class="subcategory2" data-category="大随烦恼">大随烦恼(8)</td>
        <td class="items-cell">
          <div class="items items-affliction-large">
            <button type="button" class="item-btn">48.不信</button>
            <button type="button" class="item-btn">49.懈怠</button>
            <button type="button" class="item-btn">50.放逸</button>
            <button type="button" class="item-btn">51.昏沈</button>
            <button type="button" class="item-btn">52.掉举</button>
            <button type="button" class="item-btn">53.失念</button>
            <button type="button" class="item-btn">54.不正知</button>
            <button type="button" class="item-btn">55.散乱</button>
          </div>
        </td>
      </tr>
      <tr>
        <td class="subcategory" colspan="2">不定烦恼(4)</td>
        <td class="items-cell alt">
          <div class="items items-affliction-indeterminate">
            <button type="button" class="item-btn">56.睡眠</button>
            <button type="button" class="item-btn">57.恶作</button>
            <button type="button" class="item-btn">58.寻</button>
            <button type="button" class="item-btn">59.伺</button>
          </div>
        </td>
      </tr>
      <tr>
        <td class="category color" colspan="3" data-category="色法">色法(11)</td>
        <td class="items-cell">
          <div class="items items-color">
            <button type="button" class="item-btn">60.眼</button>
            <button type="button" class="item-btn">61.耳</button>
            <button type="button" class="item-btn">62.鼻</button>
            <button type="button" class="item-btn">63.舌</button>
            <button type="button" class="item-btn">64.身</button>
            <button type="button" class="item-btn">65.色</button>
            <button type="button" class="item-btn">66.声</button>
            <button type="button" class="item-btn">67.香</button>
            <button type="button" class="item-btn">68.味</button>
            <button type="button" class="item-btn">69.触</button>
            <button type="button" class="item-btn">70.法处所摄色</button>
          </div>
        </td>
      </tr>
      <tr>
        <td class="category nonconcurrent" colspan="3" data-category="不相应行法">心不相应行法(24)</td>
        <td class="items-cell alt">
          <div class="items items-nonconcurrent">
            <button type="button" class="item-btn">71.得</button>
            <button type="button" class="item-btn">72.命根</button>
            <button type="button" class="item-btn">73.众同分</button>
            <button type="button" class="item-btn">74.异生性</button>
            <button type="button" class="item-btn">75.无想定</button>
            <button type="button" class="item-btn">76.灭尽定</button>
            <button type="button" class="item-btn">77.无想报</button>
            <button type="button" class="item-btn">78.名身</button>
            <button type="button" class="item-btn">79.句身</button>
            <button type="button" class="item-btn">80.文身</button>
            <button type="button" class="item-btn">81.生</button>
            <button type="button" class="item-btn">82.住</button>
            <button type="button" class="item-btn">83.老</button>
            <button type="button" class="item-btn">84.无常</button>
            <button type="button" class="item-btn">85.流转</button>
            <button type="button" class="item-btn">86.定异</button>
            <button type="button" class="item-btn">87.相应</button>
            <button type="button" class="item-btn">88.势速</button>
            <button type="button" class="item-btn">89.次第</button>
            <button type="button" class="item-btn">90.时</button>
            <button type="button" class="item-btn">91.方</button>
            <button type="button" class="item-btn">92.数</button>
            <button type="button" class="item-btn">93.和合性</button>
            <button type="button" class="item-btn">94.不和合性</button>
          </div>
        </td>
      </tr>
      <tr>
        <td class="category unconditioned" colspan="3" data-category="无为法">无为法(6)</td>
        <td class="items-cell">
          <div class="items items-unconditioned">
            <button type="button" class="item-btn">95.虚空</button>
            <button type="button" class="item-btn">96.择灭</button>
            <button type="button" class="item-btn">97.非择灭</button>
            <button type="button" class="item-btn">98.不动</button>
            <button type="button" class="item-btn">99.想受灭</button>
            <button type="button" class="item-btn">100.真如</button>
          </div>
        </td>
      </tr>
    </tbody>
  </table>
  <div class="baifa-tools-grid">
    <div class="baifa-tools" aria-label="五蕴和百法的对照关系">
    <div class="baifa-tools-title">五蕴对照</div>
      <div class="baifa-tools-actions">
        <button type="button" class="baifa-tools-btn" id="baifa-highlight-skandha-form" aria-pressed="false">
          色蕴
        </button>
        <button type="button" class="baifa-tools-btn" id="baifa-highlight-skandha-feeling" aria-pressed="false">
          受蕴
        </button>
        <button type="button" class="baifa-tools-btn" id="baifa-highlight-skandha-perception" aria-pressed="false">
          想蕴
        </button>
        <button type="button" class="baifa-tools-btn" id="baifa-highlight-skandha-volition" aria-pressed="false">
          行蕴
        </button>
        <button type="button" class="baifa-tools-btn" id="baifa-highlight-skandha-consciousness" aria-pressed="false">
          识蕴
        </button>
        <span class="baifa-tools-note inline">无为法不对照任何五蕴，因为蕴只是有为法。</span>
      </div>
    </div>
    <div class="baifa-tools" aria-label="十二处和百法的对照关系">
    <div class="baifa-tools-title">十二处对照</div>
      <div class="baifa-tools-actions">
        <button type="button" class="baifa-tools-btn" id="baifa-highlight-base-inner" aria-pressed="false">
          前内五处
        </button>
        <button type="button" class="baifa-tools-btn" id="baifa-highlight-base-outer" aria-pressed="false">
          前外五处
        </button>
        <button type="button" class="baifa-tools-btn" id="baifa-highlight-base-mind" aria-pressed="false">
          意处
        </button>
        <button type="button" class="baifa-tools-btn" id="baifa-highlight-base-dharma" aria-pressed="false">
          法处
        </button>
      </div>
    </div>
    <div class="baifa-tools" aria-label="十八界和百法的对照关系">
    <div class="baifa-tools-title">十八界对照</div>
      <div class="baifa-tools-actions">
        <button type="button" class="baifa-tools-btn" id="baifa-highlight-realm-roots" aria-pressed="false">
          前五根界
        </button>
        <button type="button" class="baifa-tools-btn" id="baifa-highlight-realm-objects" aria-pressed="false">
          前五境界
        </button>
        <button type="button" class="baifa-tools-btn" id="baifa-highlight-realm-senses" aria-pressed="false">
          前五识界
        </button>
        <button type="button" class="baifa-tools-btn" id="baifa-highlight-realm-mind-root" aria-pressed="false">
          意界（意根）
        </button>
        <button type="button" class="baifa-tools-btn" id="baifa-highlight-realm-consciousness" aria-pressed="false">
          意识界
        </button>
        <button type="button" class="baifa-tools-btn" id="baifa-highlight-realm-dharma" aria-pressed="false">
          法界
        </button>
      </div>
    </div>
    <div class="baifa-tools is-full-row" aria-label="心和心所的相应关系">
    <div class="baifa-tools-title">心所相应</div>
      <div class="baifa-tools-actions">
        <button type="button" class="baifa-tools-btn" id="baifa-highlight-senses" aria-pressed="false">
          前五识相应心所
        </button>
        <button type="button" class="baifa-tools-btn" id="baifa-highlight-sixth" aria-pressed="false">
          意识相应心所
        </button>
        <button type="button" class="baifa-tools-btn" id="baifa-highlight-manas" aria-pressed="false">
          末那识相应心所
        </button>
        <button type="button" class="baifa-tools-btn" id="baifa-highlight-alaya" aria-pressed="false">
          阿赖耶识相应心所
        </button>
        <button type="button" class="baifa-tools-btn" id="baifa-highlight-buddha" aria-pressed="false">
          成佛后的相应心所
        </button>
      </div>
    </div>
  </div>
  <div class="baifa-source-filters" id="baifa-source-filters" aria-label="解释来源筛选">
    <div class="baifa-source-filters-title">
      <span>解释来源</span>
      <span class="baifa-source-filters-actions">
        <button type="button" class="baifa-source-action" id="baifa-source-select-all">全选</button>
        <button type="button" class="baifa-source-action" id="baifa-source-select-plain">只显示白话解释</button>
      </span>
    </div>
    <div class="baifa-source-filters-options" id="baifa-source-filters-options"></div>
  </div>
</div>

<div class="baifa-modal" id="baifa-modal" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="baifa-modal-content">
    <button type="button" class="baifa-modal-copy" id="baifa-modal-copy" aria-label="复制" title="复制">
      <svg class="baifa-modal-icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
        <rect x="9" y="9" width="10" height="10" rx="2"></rect>
        <rect x="5" y="5" width="10" height="10" rx="2"></rect>
      </svg>
    </button>
    <button type="button" class="baifa-modal-close" id="baifa-modal-close" aria-label="关闭" title="关闭">
      <svg class="baifa-modal-icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
        <path d="M6 6l12 12M18 6l-12 12"></path>
      </svg>
    </button>
    <h3 class="baifa-modal-title" id="baifa-modal-title"></h3>
    <div class="baifa-modal-desc" id="baifa-modal-desc"></div>
  </div>
</div>

<script src="{{ site.baseurl }}/assets/js/interact.min.js"></script>
<script src="{{ site.baseurl }}/assets/js/js-yaml.min.js"></script>
<script src="{{ site.baseurl }}/assets/js/markdown-it.min.js"></script>
<script src="{{ site.baseurl }}/assets/js/baifa-sources.js"></script>
<script>
  const modal = document.getElementById('baifa-modal');
  const modalContent = document.querySelector('.baifa-modal-content');
  const modalTitle = document.getElementById('baifa-modal-title');
  const modalDesc = document.getElementById('baifa-modal-desc');
  const sourceFilters = document.getElementById('baifa-source-filters');
  const sourceFiltersOptions = document.getElementById('baifa-source-filters-options');
  const sourceSelectAll = document.getElementById('baifa-source-select-all');
  const sourceSelectPlain = document.getElementById('baifa-source-select-plain');
  const modalCopy = document.getElementById('baifa-modal-copy');
  const modalClose = document.getElementById('baifa-modal-close');
  const modalAnimationDuration = 290;
  let closeModalTimer = null;
  const buttons = Array.from(document.querySelectorAll('.item-btn'));
  const categoryCells = Array.from(document.querySelectorAll('.category[data-category], .subcategory[data-category], .subcategory2[data-category]'));
  const skandhaFormButton = document.getElementById('baifa-highlight-skandha-form');
  const skandhaFeelingButton = document.getElementById('baifa-highlight-skandha-feeling');
  const skandhaPerceptionButton = document.getElementById('baifa-highlight-skandha-perception');
  const skandhaVolitionButton = document.getElementById('baifa-highlight-skandha-volition');
  const skandhaConsciousnessButton = document.getElementById('baifa-highlight-skandha-consciousness');
  const baseInnerButton = document.getElementById('baifa-highlight-base-inner');
  const baseOuterButton = document.getElementById('baifa-highlight-base-outer');
  const baseMindButton = document.getElementById('baifa-highlight-base-mind');
  const baseDharmaButton = document.getElementById('baifa-highlight-base-dharma');
  const realmRootsButton = document.getElementById('baifa-highlight-realm-roots');
  const realmObjectsButton = document.getElementById('baifa-highlight-realm-objects');
  const realmSensesButton = document.getElementById('baifa-highlight-realm-senses');
  const realmMindRootButton = document.getElementById('baifa-highlight-realm-mind-root');
  const realmConsciousnessButton = document.getElementById('baifa-highlight-realm-consciousness');
  const realmDharmaButton = document.getElementById('baifa-highlight-realm-dharma');
  const senseHighlightButton = document.getElementById('baifa-highlight-senses');
  const sixthHighlightButton = document.getElementById('baifa-highlight-sixth');
  const manasHighlightButton = document.getElementById('baifa-highlight-manas');
  const alayaHighlightButton = document.getElementById('baifa-highlight-alaya');
  const buddhaHighlightButton = document.getElementById('baifa-highlight-buddha');
  const skandhaFormIds = createIdRangeSet(60, 70);
  const skandhaFeelingIds = new Set([11]);
  const skandhaPerceptionIds = new Set([12]);
  const skandhaVolitionIds = createIdRangeSet(9, 59);
  skandhaVolitionIds.delete(11);
  skandhaVolitionIds.delete(12);
  createIdRangeSet(71, 94).forEach((id) => {
    skandhaVolitionIds.add(id);
  });
  const skandhaConsciousnessIds = createIdRangeSet(1, 8);
  const baseInnerIds = createIdRangeSet(60, 64);
  const baseOuterIds = createIdRangeSet(65, 69);
  const baseMindIds = createIdRangeSet(1, 8);
  const baseDharmaIds = createIdRangeSet(9, 59);
  createIdRangeSet(71, 100).forEach((id) => {
    baseDharmaIds.add(id);
  });
  baseDharmaIds.add(70);
  const realmRootsIds = createIdRangeSet(60, 64);
  const realmObjectsIds = createIdRangeSet(65, 69);
  const realmSensesIds = createIdRangeSet(1, 5);
  const realmMindRootIds = new Set([7, 8]);
  const realmConsciousnessIds = new Set([6]);
  const realmDharmaIds = createIdRangeSet(9, 59);
  createIdRangeSet(71, 100).forEach((id) => {
    realmDharmaIds.add(id);
  });
  realmDharmaIds.add(70);
  const senseMindIds = new Set([
    9, 10, 11, 12, 13,
    14, 15, 16, 17, 18,
    19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29,
    30, 31, 32,
    46, 47,
    48, 49, 50, 51, 52, 53, 54, 55,
  ]);
  const manasMindIds = new Set([
    9, 10, 11, 12, 13,
    18,
    30, 32, 33, 35,
    48, 49, 50, 51, 52, 53, 54, 55,
  ]);
  const alayaMindIds = new Set([9, 10, 11, 12, 13]);
  const buddhaMindIds = createIdRangeSet(9, 29);
  const allMindIds = createIdRangeSet(9, 59);
  const highlightButtons = [
    { button: skandhaFormButton, ids: skandhaFormIds },
    { button: skandhaFeelingButton, ids: skandhaFeelingIds },
    { button: skandhaPerceptionButton, ids: skandhaPerceptionIds },
    { button: skandhaVolitionButton, ids: skandhaVolitionIds },
    { button: skandhaConsciousnessButton, ids: skandhaConsciousnessIds },
    { button: baseInnerButton, ids: baseInnerIds },
    { button: baseOuterButton, ids: baseOuterIds },
    { button: baseMindButton, ids: baseMindIds },
    { button: baseDharmaButton, ids: baseDharmaIds },
    { button: realmRootsButton, ids: realmRootsIds },
    { button: realmObjectsButton, ids: realmObjectsIds },
    { button: realmSensesButton, ids: realmSensesIds },
    { button: realmMindRootButton, ids: realmMindRootIds },
    { button: realmConsciousnessButton, ids: realmConsciousnessIds },
    { button: realmDharmaButton, ids: realmDharmaIds },
    { button: senseHighlightButton, ids: senseMindIds },
    { button: sixthHighlightButton, ids: allMindIds },
    { button: manasHighlightButton, ids: manasMindIds },
    { button: alayaHighlightButton, ids: alayaMindIds },
    { button: buddhaHighlightButton, ids: buddhaMindIds, highlightClass: 'is-highlighted-buddha' },
  ];
  const highlightClasses = ['is-highlighted', 'is-highlighted-buddha'];
  const sourceSelection = new Map();
  const markdownRenderer = window.markdownit
    ? window.markdownit({ html: false, breaks: true, linkify: true })
    : null;
  let dataPromise = null;
  let lastAnchor = null;
  let hasUserDragged = false;
  let activeHighlightButton = null;
  let currentSources = null;
  let allSourceTitles = [];
  let availableSourceTitles = new Set();

  if (sourceFiltersOptions) {
    sourceFiltersOptions.innerHTML = '<span class="baifa-source-filters-hint">来源加载中...</span>';
  }

  function getYamlCandidates() {
    const candidates = [];
    const pageUrl = window.location.href;
    const isFile = window.location.protocol === 'file:';
    if (isFile) {
      candidates.push(new URL('data/baifa.yaml', pageUrl).toString());
    } else {
      candidates.push(new URL('/data/baifa.yaml', window.location.origin).toString());
      candidates.push(new URL('data/baifa.yaml', pageUrl).toString());
    }
    candidates.push('data/baifa.yaml');
    return Array.from(new Set(candidates));
  }

  async function fetchYamlText() {
    const urls = getYamlCandidates();
    let lastError = null;
    for (const url of urls) {
      try {
        const response = await fetch(url, { cache: 'no-cache' });
        if (!response.ok) {
          throw new Error(`Failed to load ${url}: ${response.status}`);
        }
        return await response.text();
      } catch (error) {
        lastError = error;
      }
    }
    throw lastError || new Error('Failed to load YAML.');
  }

  function parseYaml(yamlText) {
    if (!window.jsyaml || typeof window.jsyaml.load !== 'function') {
      throw new Error('js-yaml not loaded');
    }
    const data = window.jsyaml.load(yamlText) || {};
    if (Array.isArray(data)) {
      return data;
    }
    return Array.isArray(data.items) ? data.items : [];
  }

  function getItemId(text) {
    const match = text.trim().match(/^(\d+)/);
    return match ? Number(match[1]) : null;
  }

  function getItemName(text) {
    return text.replace(/^\d+/, '').trim();
  }

  function createIdRangeSet(start, end) {
    const ids = new Set();
    for (let i = start; i <= end; i += 1) {
      ids.add(i);
    }
    return ids;
  }

  function clearHighlights() {
    buttons.forEach((button) => {
      highlightClasses.forEach((highlightClass) => {
        button.classList.remove(highlightClass);
      });
    });
  }

  function applyHighlight(ids, highlightClass = 'is-highlighted') {
    buttons.forEach((button) => {
      const id = getItemId(button.textContent || '');
      highlightClasses.forEach((itemClass) => {
        button.classList.remove(itemClass);
      });
      if (id && ids.has(id)) {
        button.classList.add(highlightClass);
      }
    });
  }

  function escapeHtml(text) {
    return String(text)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/\"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  function renderMarkdown(text) {
    if (!text) {
      return '';
    }
    if (markdownRenderer) {
      return markdownRenderer.render(String(text));
    }
    return escapeHtml(text).replace(/\r?\n/g, '<br>');
  }

  function prioritizePlainExplanationSources(sourceList) {
    if (!Array.isArray(sourceList) || sourceList.length === 0) {
      return sourceList;
    }
    const preferred = [];
    const rest = [];
    sourceList.forEach((source) => {
      if (source && source.title === '白话解释') {
        preferred.push(source);
      } else {
        rest.push(source);
      }
    });
    return preferred.concat(rest);
  }

  function getSourceTitleKey(source) {
    if (!source || !source.title) {
      return '未标注来源';
    }
    return source.title;
  }

  function isPlainExplanationTitle(title) {
    return title && title.includes('白话');
  }

  function prioritizePlainExplanationTitles(titles) {
    if (!Array.isArray(titles) || !titles.length) {
      return titles || [];
    }
    const preferred = [];
    const rest = [];
    titles.forEach((title) => {
      if (isPlainExplanationTitle(title)) {
        preferred.push(title);
      } else {
        rest.push(title);
      }
    });
    return preferred.concat(rest);
  }

  function sortSourceTitles(titles) {
    const list = Array.isArray(titles) ? titles.slice() : [];
    const sorted = window.baifaSortSourceTitles ? window.baifaSortSourceTitles(list) : list;
    return prioritizePlainExplanationTitles(sorted);
  }

  function refreshFiltersAndModal() {
    if (Array.isArray(currentSources)) {
      renderModalSources();
    } else {
      renderSourceFilters();
    }
  }

  function isSourceSelected(title) {
    if (!title) {
      return false;
    }
    if (sourceSelection.has(title)) {
      return sourceSelection.get(title);
    }
    return isPlainExplanationTitle(title);
  }

  function setSourceSelected(title, selected) {
    if (!title) {
      return;
    }
    sourceSelection.set(title, selected);
  }

  function applySelectionToAllTitles(selector) {
    allSourceTitles.forEach((title) => {
      setSourceSelected(title, selector(title));
    });
    refreshFiltersAndModal();
  }

  function getOrderedSources(sources) {
    if (!Array.isArray(sources) || !sources.length) {
      return [];
    }
    const orderedSources = window.baifaSortSources ? window.baifaSortSources(sources) : sources.slice();
    return prioritizePlainExplanationSources(orderedSources);
  }

  function renderSourcesFromOrdered(orderedSources) {
    if (!orderedSources || !orderedSources.length) {
      return '<div class=\"baifa-section-body\">暂无解释。</div>';
    }
    const htmlParts = [];
    for (const source of orderedSources) {
      const titleText = getSourceTitleKey(source);
      if (titleText) {
        htmlParts.push(`<div class=\"baifa-section-title\">${escapeHtml(titleText)}</div>`);
      }
      if (source && source.content) {
        htmlParts.push(`<div class=\"baifa-section-body\">${renderMarkdown(source.content)}</div>`);
      }
    }
    return htmlParts.join('');
  }

  function renderSources(sources) {
    return renderSourcesFromOrdered(getOrderedSources(sources));
  }

  function collectAllSourceTitles(items) {
    const titles = [];
    const seen = new Set();
    const list = Array.isArray(items) ? items : [];
    list.forEach((item) => {
      const sources = item && Array.isArray(item.sources) ? item.sources : [];
      sources.forEach((source) => {
        const title = getSourceTitleKey(source);
        if (!seen.has(title)) {
          seen.add(title);
          titles.push(title);
        }
      });
    });
    return sortSourceTitles(titles);
  }

  function updateAvailableSourceTitles(sources) {
    const set = new Set();
    const list = Array.isArray(sources) ? sources : [];
    list.forEach((source) => {
      set.add(getSourceTitleKey(source));
    });
    availableSourceTitles = set;
  }

  function renderSourceFilters() {
    if (!sourceFiltersOptions) {
      return;
    }
    sourceFiltersOptions.innerHTML = '';
    if (!allSourceTitles.length) {
      sourceFiltersOptions.innerHTML = '<span class="baifa-source-filters-hint">暂无来源</span>';
      return;
    }
    allSourceTitles.forEach((title, index) => {
      const label = document.createElement('label');
      label.className = 'baifa-filter-option';
      const input = document.createElement('input');
      const isAvailable = Array.isArray(currentSources) ? availableSourceTitles.has(title) : true;
      input.type = 'checkbox';
      input.id = `baifa-source-filter-${index}`;
      input.checked = isSourceSelected(title);
      input.disabled = !isAvailable;
      if (!isAvailable) {
        label.classList.add('is-disabled');
      }
      input.addEventListener('change', () => {
        setSourceSelected(title, input.checked);
        renderModalSources();
      });
      const span = document.createElement('span');
      span.textContent = title;
      label.appendChild(input);
      label.appendChild(span);
      sourceFiltersOptions.appendChild(label);
    });
  }

  function renderModalSources() {
    if (!Array.isArray(currentSources)) {
      return;
    }
    const orderedSources = getOrderedSources(currentSources);
    updateAvailableSourceTitles(currentSources);
    renderSourceFilters();
    const filteredSources = orderedSources.filter((source) => isSourceSelected(getSourceTitleKey(source)));
    if (!filteredSources.length) {
      modalDesc.innerHTML = '<div class=\"baifa-section-body\">暂无解释，可在下方勾选来源。</div>';
      return;
    }
    modalDesc.innerHTML = renderSourcesFromOrdered(filteredSources);
  }

  function loadBaifaData() {
    if (!dataPromise) {
      dataPromise = fetchYamlText().then((yamlText) => parseYaml(yamlText));
    }
    return dataPromise;
  }

  loadBaifaData()
    .then((data) => {
      allSourceTitles = collectAllSourceTitles(data);
      renderSourceFilters();
    })
    .catch(() => {
      if (sourceFiltersOptions) {
        sourceFiltersOptions.innerHTML = '<span class="baifa-source-filters-hint">来源加载失败</span>';
      }
    });

  if (sourceSelectAll) {
    sourceSelectAll.addEventListener('click', () => {
      applySelectionToAllTitles(() => true);
    });
  }

  if (sourceSelectPlain) {
    sourceSelectPlain.addEventListener('click', () => {
      applySelectionToAllTitles((title) => isPlainExplanationTitle(title));
    });
  }

  function getModalSize() {
    const width = modalContent.offsetWidth;
    const height = modalContent.offsetHeight;
    if (width && height) {
      return { width, height };
    }
    const rect = modalContent.getBoundingClientRect();
    return { width: rect.width, height: rect.height };
  }

  function getModalCenteredPosition(size) {
    const margin = 8;
    let left = (window.innerWidth - size.width) / 2;
    let top = (window.innerHeight - size.height) / 2;
    left = Math.max(margin, Math.min(left, window.innerWidth - size.width - margin));
    top = Math.max(margin, Math.min(top, window.innerHeight - size.height - margin));
    return { left, top };
  }

  function getModalTargetPosition(anchor, size) {
    if (!anchor) {
      return getModalCenteredPosition(size);
    }
    const rect = anchor.getBoundingClientRect();
    const gap = 8;
    const margin = 8;
    let left = rect.left;
    let top = rect.bottom + gap;
    left = Math.max(margin, Math.min(left, window.innerWidth - size.width - margin));
    top = Math.max(margin, Math.min(top, window.innerHeight - size.height - margin));
    return { left, top };
  }

  function applyModalPosition(position) {
    modalContent.style.left = `${position.left}px`;
    modalContent.style.top = `${position.top}px`;
  }

  function positionModal(anchor) {
    if (!anchor) {
      return;
    }
    if (hasUserDragged) {
      return;
    }
    const size = getModalSize();
    const target = getModalTargetPosition(anchor, size);
    applyModalPosition(target);
  }

  function openModal(title, content, anchor) {
    modalTitle.textContent = title;
    if (Array.isArray(content)) {
      currentSources = content;
      renderModalSources();
    } else {
      currentSources = [];
      updateAvailableSourceTitles(currentSources);
      renderSourceFilters();
      const text = content || '暂无解释。';
      modalDesc.innerHTML = `<div class=\"baifa-section-body\">${renderMarkdown(text)}</div>`;
    }
    if (closeModalTimer) {
      window.clearTimeout(closeModalTimer);
      closeModalTimer = null;
    }
    modal.classList.add('active');
    modal.classList.remove('is-open', 'is-closing');
    modal.setAttribute('aria-hidden', 'false');
    hasUserDragged = false;
    lastAnchor = anchor || lastAnchor;
    positionModal(lastAnchor);
    window.requestAnimationFrame(() => {
      modal.classList.add('is-open');
    });
  }

  function closeModal() {
    if (!modal.classList.contains('active')) {
      return;
    }
    modal.classList.add('is-closing');
    modal.classList.remove('is-open');
    modal.setAttribute('aria-hidden', 'true');
    if (closeModalTimer) {
      window.clearTimeout(closeModalTimer);
    }
    closeModalTimer = window.setTimeout(() => {
      modal.classList.remove('active', 'is-closing');
      closeModalTimer = null;
    }, modalAnimationDuration);
  }

  function getModalCopyText() {
    const titleText = modalTitle.textContent ? modalTitle.textContent.trim() : '';
    const descText = modalDesc.innerText ? modalDesc.innerText.trim() : '';
    return [titleText, descText].filter(Boolean).join('\n\n');
  }

  function setCopyButtonState(state) {
    if (!modalCopy) {
      return;
    }
    modalCopy.classList.remove('is-copied', 'is-failed');
    if (state === 'copied') {
      modalCopy.classList.add('is-copied');
      modalCopy.setAttribute('aria-label', '已复制');
      modalCopy.setAttribute('title', '已复制');
      return;
    }
    if (state === 'failed') {
      modalCopy.classList.add('is-failed');
      modalCopy.setAttribute('aria-label', '复制失败');
      modalCopy.setAttribute('title', '复制失败');
      return;
    }
    modalCopy.setAttribute('aria-label', '复制');
    modalCopy.setAttribute('title', '复制');
  }

  async function copyModalText() {
    const text = getModalCopyText();
    if (!text) {
      return;
    }
    try {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        await navigator.clipboard.writeText(text);
      } else {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.setAttribute('readonly', '');
        textarea.style.position = 'absolute';
        textarea.style.left = '-9999px';
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
      }
      setCopyButtonState('copied');
      window.setTimeout(() => {
        setCopyButtonState('default');
      }, 1200);
    } catch (error) {
      setCopyButtonState('failed');
      window.setTimeout(() => {
        setCopyButtonState('default');
      }, 1200);
    }
  }

  buttons.forEach((button) => {
    button.addEventListener('click', async () => {
      const rawText = button.textContent || '';
      const id = getItemId(rawText);
      if (!id) {
        return;
      }
      const name = getItemName(rawText);
      try {
        const data = await loadBaifaData();
        const items = Array.isArray(data) ? data : (data && data.items) || [];
        const item = items.find((entry) => Number(entry.id) === id);
        const titleText = item && item.name ? item.name : name;
        const title = `第${id}法：${titleText}`;
        const sources = item && item.sources ? item.sources : [];
        openModal(title, sources, button);
      } catch (error) {
        openModal(`${id} ${name}`, '解释加载失败，请稍后重试。', button);
      }
    });
  });

  categoryCells.forEach((cell) => {
    cell.addEventListener('click', async () => {
      const name = cell.dataset.category;
      if (!name) {
        return;
      }
      try {
        const data = await loadBaifaData();
        const items = Array.isArray(data) ? data : (data && data.items) || [];
        const item = items.find((entry) => entry && entry.type === 'category' && entry.name === name);
        const title = `${name}分类`;
        const sources = item && item.sources ? item.sources : [];
        openModal(title, sources, cell);
      } catch (error) {
        openModal(`${name}分类`, '解释加载失败，请稍后重试。', cell);
      }
    });
  });

  if (modalCopy) {
    modalCopy.addEventListener('click', copyModalText);
  }
  modalClose.addEventListener('click', closeModal);
  document.addEventListener('keydown', (event) => {
    if (event.key === 'Escape') {
      closeModal();
    }
  });
  if (window.interact) {
    window.interact(modalContent).draggable({
      allowFrom: '.baifa-modal-title',
      listeners: {
        move(event) {
          const margin = 8;
          const rect = modalContent.getBoundingClientRect();
          const currentLeft = Number.parseFloat(modalContent.style.left) || rect.left;
          const currentTop = Number.parseFloat(modalContent.style.top) || rect.top;
          const maxLeft = window.innerWidth - rect.width - margin;
          const maxTop = window.innerHeight - rect.height - margin;
          const left = Math.min(Math.max(margin, currentLeft + event.dx), maxLeft);
          const top = Math.min(Math.max(margin, currentTop + event.dy), maxTop);
          hasUserDragged = true;
          modalContent.style.left = `${left}px`;
          modalContent.style.top = `${top}px`;
        },
      },
    });
  }
  window.addEventListener('resize', () => {
    if (modal.classList.contains('active')) {
      positionModal(lastAnchor);
    }
  });
  window.addEventListener('scroll', () => {
    if (modal.classList.contains('active')) {
      positionModal(lastAnchor);
    }
  }, { passive: true });

  function updateHighlightButtons() {
    highlightButtons.forEach(({ button }) => {
      if (!button) {
        return;
      }
      button.setAttribute('aria-pressed', button === activeHighlightButton ? 'true' : 'false');
    });
  }

  highlightButtons.forEach(({ button, ids }) => {
    if (!button) {
      return;
    }
    button.addEventListener('click', () => {
      if (activeHighlightButton === button) {
        activeHighlightButton = null;
        clearHighlights();
        updateHighlightButtons();
        return;
      }
      const config = highlightButtons.find((entry) => entry.button === button);
      applyHighlight(ids, (config && config.highlightClass) || 'is-highlighted');
      activeHighlightButton = button;
      updateHighlightButtons();
    });
  });
</script>
